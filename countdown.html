<!DOCTYPE html>
<header>
	<style>
        html, body {
            width: 100%;
            height: 100%;
        }
        content {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
       	minutes, actions {
			display: flex;
            justify-content: center;
            flex-wrap: wrap;
            align-content: stretch;
		}		
		minutes button, actions button {
            flex: 0 0 30%;
			font-size: 2em;
			text-align: center;
		}	
        main {
			display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
		}
		time {
			display: flex;
            flex-direction: column;
            justify-content: space-around;
            flex-wrap: wrap;
            align-items: center;
            flex: 1;
		}
		time div{
			font-family: 'ZCOOL QingKe HuangYou', cursive;
			font-size: 10em;
			text-align: center;
		}
        timelist{            
            font-family: 'ZCOOL QingKe HuangYou', cursive;
			font-size: 1.3em;      
        }
        timelist ul{
            list-style: none;
        }
        footer {
			display: flex;
            justify-content: center;
            align-content: stretch;
		}
	</style>
	<link href="https://fonts.googleapis.com/css?family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
</header>


<content>
    <header>
        <minutes>
            <button id="button1" data-cy="button1" value="1">‚ûï <br>1min</button>
            <button id="button5" data-cy="button5" value="5">‚ûï <br>5min</button>
            <button id="button10" data-cy="button10" value="10">‚ûï <br>10min</button>
        </minutes>
        <actions>
            <button id="buttonStart" data-cy="buttonStart">‚ñ∂Ô∏è <br>Start</button>
            <button id="buttonStop" data-cy="buttonStop">‚èπÔ∏è <br>Stop</button>
            <button id="buttonReset" data-cy="buttonReset">üóëÔ∏è <br>Reset</button>
            <button id="buttonList" data-cy="buttonList">‚äï <br>To List</button>
        </actions>
    </header>
    <main>      
        <timelist>
            <ul></ul>
        </timelist>      
        <time>
            <div data-cy="timerHours" id="timerHours"></div>
            <div data-cy="timerMinutes" id="timerMinutes"></div>
            <div data-cy="timerSeconds" id="timerSeconds"></div>
        </time>            
    </main>
    <footer>
        <audio data-cy="alarm" src="media/boxing_bell.mp3" controls>
            Your browser does not support the <code>audio</code> element.
        </audio>
    </footer>
</content>

<script>
(function() {
    let timeList = [];
    let countDownTime = 0;
    let countDownDate;
    let timerInterval;

    document.addEventListener("keyup", (e) => {
        // console.log(e.key);
        // switch(e.key){
        //     case "Enter":                 
        //         document.querySelector('#buttonList').focus();
        //         document.querySelector('#buttonList').click();
            // case "1":
            //     document.querySelector('button[value="1"][data-cy="button1"]').click();
            // case "5":
            //     document.querySelector('button[data-cy="button1"]').click();
            // case "9":
            //     document.querySelector('button[data-cy="button1"]').click();
        // }
    });

    const handleButtons = (e) => {
        let button = e.target;
        switch(button.dataset.cy){
            case "buttonStart":								
                start();
                break;
            case "buttonStartFromList":	
                startFromTimerList(button.getAttribute("key"));
                break;
            case "buttonStop":
                stop();
                break;
            case "buttonReset":
                reset();
                break;
            case "buttonList":
                countDownTime += button.value * 1000 * 60;
                var now = new Date();
                countDownDate = new Date(now.getTime() + countDownTime);
                add(countDownTime);
                break;
            default:
                countDownTime += button.value * 1000 * 60;
                var now = new Date();
                countDownDate = new Date(now.getTime() + countDownTime);
                show(countDownTime);				
        }		
    };

    const addButtonEvents = () => {
        document.querySelectorAll("button").forEach( (button) => {
            button.removeEventListener("click", handleButtons);
            button.addEventListener("click", handleButtons);
        });
    };
    addButtonEvents();
    

    const pad = (n) => {return n<10 ? '0'+n : n};

    const splitTime = (time = 0) => {
        // Time calculations for days, hours, minutes and seconds
        var days = pad(Math.floor(time / (1000 * 60 * 60 * 24)));
        var hours = pad(Math.floor((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))) + "h ";
        var minutes = pad(Math.floor((time % (1000 * 60 * 60)) / (1000 * 60))) + "m ";
        var seconds = pad(Math.floor((time % (1000 * 60)) / 1000)) + "s ";
        return {days, hours, minutes, seconds};
    }

    const show = (time = 0) => {
        let {days, hours, minutes, seconds} = splitTime(time);
        // Display the result
        document.getElementById("timerHours").innerHTML = hours;
        document.getElementById("timerMinutes").innerHTML = minutes;
        document.getElementById("timerSeconds").innerHTML = seconds;
    }
    show();

    const add = (time = 0) => {
        if( countDownTime > 0 )
        {
            let {days, hours, minutes, seconds} = splitTime(time);            
            timeList.push(time);
            const list      = document.querySelector('timelist > ul');

            const button    = document.createElement('button');
            button.appendChild(document.createTextNode("‚ñ∂Ô∏è"));
            button.setAttribute('data-cy', 'buttonStartFromList');
            button.setAttribute('key', timeList.length-1);

            const li        = document.createElement("li");
            li.appendChild(button);
            li.appendChild(document.createTextNode(` ${hours}:${minutes}:${seconds}`));
            
            list.appendChild(li);
            addButtonEvents();

            reset();
        }
    }

    const reset= () => {
        stop();
        countDownTime = 0;
        show();
    }

    const stop= () => {
        clearInterval(timerInterval);
    }

    // const startTimerList = () => {
    //     if( timeList.length > 0 ){
    //         countDownTime = timeList[0];
    //         timeList.shift();         
    //         let list = document.querySelector('timelist > ul');
    //         list.removeChild(list.childNodes[0]); 
    //         show(countDownTime);
    //         timerInterval = setInterval(function() {
    //             countDownTime = countDownTime - ( 1000 );
    //             show(countDownTime);
    //             // If the count down is finished, reset and play sound
    //             if (countDownTime  < 0) {            
    //                 reset();
    //                 document.querySelector("audio").play();                    
    //                 startTimerList();
    //             }
    //         }, 1000); 
    //     }               
    // }

    const startFromTimerList = (index) => {
        reset();
        countDownTime = timeList[index];
        let list = document.querySelector('timelist > ul');
        for(let i = 0; i <= index; i++){
            timeList.shift();            
            list.removeChild(list.childNodes[0]); 
        }
        list.childNodes.forEach( (li, i) => {
            li.querySelector("button").setAttribute("key", i);
        })        
        start();
    }
    

    const start = (index = 0) => {     
        if( timeList.length > 0 && countDownTime == 0 ){
            startFromTimerList(index);
            show(countDownTime);
        }

        var now = new Date();
        countDownDate = new Date(now.getTime() + countDownTime);
        // Update the count down every 1 second
        timerInterval= setInterval(function() {
            // Get today's date and time
            // var start = new Date().getTime();

            // Find the distance between start and the count down date
            // countDownTime = countDownDate - start;
            // just a workaround for now
            countDownTime = countDownTime - ( 1000 );

            show(countDownTime);
            // If the count down is finished, reset and play sound
            if (countDownTime  < 0) {            
                reset();
                document.querySelector("audio").play();
            }
        }, 1000);               
    }

})();
</script>